<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <title>Document</title>
</head>
<body>
    <!-- Provide a Module stub so we can set onRuntimeInitialized before the Emscripten glue runs -->
    <script>
        var Module = typeof Module !== 'undefined' ? Module : {};
    </script>

    <script src="a.out.js"></script>

    <h2>Fibonacci Wasm vs JS</h2>
    <p>for best results use n value between 20 and 40</p>
    <div class="container">
        <label>n: <input id="fibN" type="number" value="20" min="1"/></label>
        <button id="runJs">Run JS Fib</button>
        <button id="runWasm">Run Wasm Fib</button>
        <button id="compare">Compare (single run)</button>
        <button id="clear">clear results</button>
        <pre id="out" style="background:#f6f6f6;padding:8px;border:1px solid #ddd;">Output will appear here</pre>
    </div>

    <script>
        // javascript fibonacci implementation
        function jsFib(n) {
            if (n === 1) return 1;
            if (n === 2) return 1;
            return jsFib(n-1) + jsFib(n-2);
        }

        // Helper to obtain the exported fib implementation from the wasm module.
        function getWasmFibFunction() {
            // If emscripten provided cwrap/call wrappers
            try {
                if (typeof Module !== 'undefined' && Module.cwrap) {
                    try {
                        var wrapped = Module.cwrap('fib', 'number', ['number']);
                        if (typeof wrapped === 'function') return wrapped;
                    } catch(e) {
                        console.log("error:", e.message);
                    }
                }
            } catch(e) {
                console.log("error:", e.message);
            }
        }

        function show(msg) {
            var out = document.getElementById('out');
            out.textContent = msg + '\n' + out.textContent;
        }

        function timeAndRun(func, arg) {
            var t0 = performance.now();
            var res = func(arg);
            var t1 = performance.now();
            return { result: res, timeMs: t1 - t0 };
        }

        document.getElementById('runJs').addEventListener('click', function() {
            var n = Number(document.getElementById('fibN').value) || 0;
            var r = timeAndRun(jsFib, n);
            show(`JS fib(${n}) = ${r.result}    time=${r.timeMs.toFixed(3)}ms`);
        });

        document.getElementById('runWasm').addEventListener('click', function() {
            var n = Number(document.getElementById('fibN').value) || 0;
            var fn = getWasmFibFunction();
            if (!fn) {
                show('No exported wasm fib function found.');
                return;
            }
            var r = timeAndRun(fn, n);
            show(`WASM fib(${n}) = ${r.result}    time=${r.timeMs.toFixed(3)}ms`);
        });

        document.getElementById('compare').addEventListener('click', function() {
            var n = Number(document.getElementById('fibN').value) || 0;
            var wasmFn = getWasmFibFunction();
            if (!wasmFn) {
                show('No exported wasm fib function found.');
                return;
            }
            var j = timeAndRun(jsFib, n);
            var w = timeAndRun(wasmFn, n);
            var ok = (j.result === w.result);
            show(`COMPARE n=${n}  JS=${j.result} (${j.timeMs.toFixed(0)}ms)  WASM=${w.result} (${w.timeMs.toFixed(0)}ms)  equal=${ok}`);
        });

        document.getElementById('clear').addEventListener('click', function() {
            var out = document.getElementById('out');
            out.textContent = '';
        });

        // If the runtime is already initialized, nothing else needed. If not, set a handler so the user can click after initialization.
       /* if (Module && Module.calledRun) {
            show('Wasm runtime already initialized.');
        } else {
            // Provide a visual note once runtime initializes
            var prev = Module.onRuntimeInitialized;
            Module.onRuntimeInitialized = function() {
                if (typeof prev === 'function') prev();
                show('Wasm runtime initialized. You can now press "Run Wasm Fib" or "Compare".');
            };
        }*/
    </script>
</body>
</html>